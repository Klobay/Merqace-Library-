<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Merqace Library</title>
<style>
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #0f0f0f;
    color: white;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    position: relative;
  }
  header {
    position: sticky;
    top: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 20px;
    backdrop-filter: blur(16px);
    background: rgba(20, 20, 20, 0.5);
    z-index: 1000;
  }
  .logo {
    font-size: 1.5rem;
    font-weight: bold;
    transition: opacity 0.3s ease;
  }
  .logo.hidden {
    opacity: 0;
    visibility: hidden;
  }
  #signupLoginBtn, #uploadBtnHeader {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    padding: 8px 14px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 0.9em;
    transition: background 0.3s ease;
  }
  #uploadBtnHeader:hover {
    background: rgba(255, 255, 255, 0.3);
  }
  #uploadProgress {
    position: fixed;
    top: 70px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.1);
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 0.9em;
    display: none;
    z-index: 1000;
  }
  #hamburgerBtn {
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    gap: 4px;
    z-index: 1100;
  }
  #hamburgerBtn span {
    width: 24px;
    height: 3px;
    background: white;
    border-radius: 2px;
    transition: all 0.3s ease;
  }
  #hamburgerBtn.active span:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
  }
  #hamburgerBtn.active span:nth-child(2) {
    opacity: 0;
  }
  #hamburgerBtn.active span:nth-child(3) {
    transform: rotate(-45deg) translate(5px, -5px);
  }
  .menu {
    display: none;
    flex-direction: column;
    position: absolute;
    top: 60px;
    right: 20px;
    background: rgba(30, 30, 30, 0.8);
    backdrop-filter: blur(20px);
    padding: 15px;
    border-radius: 12px;
    animation: fadeIn 0.3s ease;
    min-width: 160px;
    z-index: 1050;
  }
  .menu.show {
    display: flex;
  }
  .menu a, .menu button {
    color: white;
    text-decoration: none;
    padding: 10px 12px;
    border-radius: 8px;
    transition: background 0.2s ease;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1em;
    text-align: left;
  }
  .menu a:hover, .menu button:hover {
    background: rgba(255, 255, 255, 0.1);
  }
  #welcomeSection, #converterSection, #profileSection, #searchSection, #friendListSection {
    text-align: center;
    padding: 40px 20px;
    flex: 1;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    animation: fadeInUp 1s ease;
    position: relative;
    z-index: 1;
  }
  #chatSection {
    text-align: center;
    padding: 40px 20px;
    flex: 1;
    display: none;
    flex-direction: column;
    align-items: center;
    animation: fadeInUp 1s ease;
    position: relative;
    z-index: 1;
  }
  #welcomeMessage {
    font-size: 2.5rem;
    font-weight: bold;
    margin-bottom: 10px;
  }
  #description {
    font-size: 1.2rem;
    color: #ccc;
  }
  .cursor {
    display: inline-block;
    width: 3px;
    height: 1em;
    background: white;
    vertical-align: middle;
    animation: blink 0.7s infinite;
  }
  @keyframes blink {
    50% { opacity: 0; }
  }
  .dot {
    position: absolute;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 50%;
    pointer-events: none;
    z-index: 0;
    animation: moveDot 5s infinite ease-in-out;
  }
  @keyframes moveDot {
    0% { transform: translate(0, 0) scale(1); opacity: 0.7; }
    50% { transform: translate(var(--x-move), var(--y-move)) scale(1.5); opacity: 0.3; }
    100% { transform: translate(0, 0) scale(1); opacity: 0.7; }
  }
  main.gallery {
    display: none;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
    padding: 15px;
    flex: 1;
    min-height: 60vh;
  }
  .card {
    background: rgba(255, 255, 255, 0.02);
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
    animation: fadeInUp 0.4s ease;
    aspect-ratio: 1 / 1;
    position: relative;
  }
  .card:hover {
    transform: scale(1.04);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  }
  .card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .delete-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: rgba(255, 0, 0, 0.7);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .card:hover .delete-btn {
    opacity: 1;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  #previewModal, #signupLoginModal, #messageModal, #disconnectModal, #friendRequestModal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(20px);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    animation: fadeIn 0.3s ease;
  }
  #previewModal.show, #signupLoginModal.show, #messageModal.show, #disconnectModal.show, #friendRequestModal.show {
    display: flex;
  }
  #previewImage {
    max-width: 90%;
    max-height: 85%;
    border-radius: 12px;
    box-shadow: 0 0 60px rgba(0,0,0,0.7);
  }
  #previewDownload {
    position: absolute;
    top: 20px;
    left: 20px;
    padding: 8px 12px;
    background: rgba(255, 255, 250, 0.1);
    color: white;
    border-radius: 8px;
    text-decoration: none;
    font-size: 0.85em;
  }
  #signupLoginModalContent, #messageModalContent, #disconnectModalContent, #friendRequestModalContent {
    background: rgba(20, 20, 20, 0.85);
    padding: 20px 25px 30px 25px;
    border-radius: 12px;
    max-width: 320px;
    width: 90%;
    color: white;
    box-shadow: 0 0 40px rgba(0,0,0,0.9);
    text-align: center;
  }
  #signupLoginModalContent h2, #messageModalContent h2, #disconnectModalContent h2, #friendRequestModalContent h2 {
    margin-bottom: 15px;
  }
  #signupUsername, #signupPassword, #loginUsername, #loginPassword, #adminPassword, #profileUsername, #profilePassword, #profileConfirmPassword, #searchInput {
    width: 100%;
    padding: 8px 10px;
    font-size: 0.9em;
    border-radius: 8px;
    border: none;
    margin-bottom: 15px;
    background: #222;
    color: white;
  }
  #profilePictureInput {
    display: none;
  }
  #profilePicturePreview {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 15px;
    background: rgba(255, 255, 255, 0.1);
    display: block;
    margin-left: auto;
    margin-right: auto;
  }
  #profilePictureBtn {
    background: rgba(255, 255, 255, 0.05);
    border: none;
    color: white;
    padding: 8px 16px;
    font-size: 0.9em;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    margin-bottom: 15px;
  }
  #profilePictureBtn:hover {
    background: rgba(255, 255, 255, 0.3);
    color: black;
    transform: scale(1.05);
  }
  #signupLoginButtons, #messageButtons, #disconnectButtons, #profileButtons, #friendRequestButtons {
    display: flex;
    justify-content: center;
    gap: 15px;
  }
  #messageButtons, #disconnectButtons, #profileButtons, #friendRequestButtons {
    margin-top: 15px;
  }
  button.modalBtn {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    padding: 6px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9em;
    transition: background-color 0.3s ease, color 0.3s ease;
    min-width: 70px;
  }
  button.modalBtn:hover, button.modalBtn:focus {
    background: white;
    color: black;
    outline: none;
  }
  #signupLoginTabs {
    display: flex;
    justify-content: space-around;
    margin-bottom: 15px;
  }
  .tabBtn {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9em;
    transition: background-color 0.3s ease;
  }
  .tabBtn.active {
    background: rgba(255, 255, 255, 0.3);
  }
  .tabBtn:hover {
    background: rgba(255, 255, 255, 0.2);
  }
  .tabContent {
    display: none;
  }
  .tabContent.active {
    display: block;
  }
  footer {
    text-align: center;
    padding: 10px;
    font-size: 0.8em;
    color: #777;
    width: 100%;
  }
  #fileInput {
    display: none;
  }
  .converter-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 500px;
    z-index: 1;
  }
  .converter-container h1 {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 10px;
    animation: fadeInUp 1s ease;
  }
  .instructions {
    text-align: center;
    margin: 0 15px 15px;
    font-size: 1rem;
    color: #ccc;
    max-width: 450px;
    animation: fadeInUp 1s ease;
  }
  .textarea-container {
    position: relative;
    margin-bottom: 15px;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  textarea, #outputText, #chatInput {
    width: 100%;
    min-height: 90px;
    padding: 8px;
    font-size: 0.9em;
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    color: white;
    resize: none;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
    animation: fadeInUp 0.4s ease;
    text-align: left;
  }
  #outputText {
    word-wrap: break-word;
  }
  .clear-button {
    position: absolute;
    right: 8px;
    top: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    border: none;
    padding: 4px;
    font-size: 0.8em;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.3s ease, opacity 0.3s ease;
    opacity: 0.7;
  }
  .clear-button:hover {
    background: rgba(255, 255, 255, 0.3);
    opacity: 1;
  }
  .button-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    width: 100%;
    margin-bottom: 15px;
  }
  .button-container button {
    background: rgba(255, 255, 255, 0.05);
    border: none;
    color: white;
    padding: 8px 16px;
    font-size: 0.9em;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease;
    width: 100%;
    max-width: 180px;
  }
  .button-container button:hover {
    background: rgba(255, 255, 255, 0.3);
    color: black;
    transform: scale(1.05);
  }
  .converter-container h2 {
    margin-top: 15px;
    text-align: center;
    width: 100%;
    max-width: 450px;
    font-size: 1.2rem;
    animation: fadeInUp 0.4s ease;
  }
  #searchResults, #friendList, #chatMessages {
    width: 100%;
    max-width: 500px;
    margin-top: 20px;
  }
  .search-result, .friend-item, .chat-message {
    background: rgba(255, 255, 255, 0.05);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .search-result button, .friend-item button, .chat-message button {
    background: rgba(255, 255, 255, 0.1);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 0.9em;
    margin-left: 5px;
  }
  .search-result button:hover, .friend-item button:hover, .chat-message button:hover {
    background: rgba(255, 255, 255, 0.3);
  }
  .chat-message {
    flex-direction: column;
    align-items: flex-start;
  }
  .chat-message p {
    margin: 5px 0;
  }
  .chat-controls {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    width: 100%;
    max-width: 500px;
    flex-wrap: wrap;
  }
  .chat-controls button {
    background: rgba(255, 255, 255, 0.05);
    border: none;
    color: white;
    padding: 8px 16px;
    font-size: 0.9em;
    border-radius: 8px;
    cursor: pointer;
  }
  .chat-controls button:hover {
    background: rgba(255, 255, 255, 0.3);
    color: black;
  }
  .chat-header {
    width: 100%;
    max-width: 500px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .chat-header h2 {
    font-size: 1.5rem;
  }
  @media (max-width: 768px) {
    header { padding: 10px 15px; }
    #signupLoginBtn, #uploadBtnHeader { padding: 6px 10px; font-size: 0.8em; }
    #hamburgerBtn span { width: 20px; height: 2.5px; }
    .menu { top: 50px; right: 15px; padding: 10px; min-width: 140px; }
    .menu a, .menu button { padding: 8px 10px; font-size: 0.9em; }
    #welcomeSection, #converterSection, #profileSection, #searchSection, #friendListSection, #chatSection { padding: 20px 10px; }
    #welcomeMessage { font-size: 1.8rem; }
    #description { font-size: 1rem; }
    main.gallery { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; padding: 10px; }
    #previewImage { max-width: 95%; max-height: 80%; border-radius: 10px; }
    #signupLoginModalContent, #messageModalContent, #disconnectModalContent, #friendRequestModalContent {
      padding: 15px 20px 25px 20px;
      max-width: 280px;
    }
    .converter-container { max-width: 400px; }
    .converter-container h1 { font-size: 1.5rem; }
    .instructions { font-size: 0.9em; max-width: 350px; }
    textarea, #outputText, #chatInput { min-height: 80px; padding: 6px; font-size: 0.8em; }
    #searchResults, #friendList, #chatMessages { max-width: 350px; }
  }
</style>
</head>
<body>
  <header>
    <div class="logo">Merqace Library</div>
    <div style="display: flex; align-items: center; gap: 10px;">
      <button id="uploadBtnHeader" aria-label="Upload Images">Upload</button>
      <button id="signupLoginBtn" aria-label="Sign Up or Login">Sign Up/Login</button>
      <button id="hamburgerBtn" aria-label="Menu" aria-expanded="false"><span></span><span></span><span></span></button>
    </div>
    <nav class="menu" id="menu" role="navigation">
      <a href="#" id="homeBtn">Home</a>
      <button id="signupLoginMenuBtn">Sign Up/Login</button>
      <a href="#" id="wallpapersBtn" style="display: none;">Wallpapers</a>
      <a href="#" id="converterBtn" style="display: none;">Numora Converter</a>
      <a href="#" id="profileBtn" style="display: none;">Profile</a>
      <a href="#" id="searchBtn" style="display: none;">Search Users</a>
      <a href="#" id="friendListBtn" style="display: none;">Friend List</a>
      <button id="disconnectBtn" style="display: none;">Disconnect</button>
    </nav>
  </header>

  <div id="uploadProgress" role="status"></div>

  <section id="welcomeSection" role="main">
    <div id="welcomeMessage" aria-live="polite"></div>
    <div id="description" aria-live="polite"></div>
  </section>

  <main class="gallery" id="gallery" role="region" aria-label="Image Gallery"></main>

  <section id="converterSection" role="region" aria-label="Numora Converter">
    <div class="converter-container">
      <h1>Numora Converter</h1>
      <p class="instructions">
        Convert text between the alphabet and Numora in real-time! Type in the box below, and the conversion will happen automatically.
      </p>
      <div class="textarea-container">
        <textarea id="inputText" rows="4" placeholder="Enter text here..." aria-label="Input text for conversion"></textarea>
        <button class="clear-button" onclick="clearText()" aria-label="Clear input text">×</button>
      </div>
      <div class="button-container">
        <button id="toggleButton" onclick="toggleConversion()">Alphabet → Numora</button>
        <button onclick="copyOutput()">Copy Converted Text</button>
      </div>
      <h2>Converted Text:</h2>
      <p id="outputText" aria-live="polite"></p>
    </div>
  </section>

  <section id="profileSection" role="region" aria-label="Profile Settings">
    <div class="converter-container">
      <h1>Edit Profile</h1>
      <p class="instructions">Update your profile picture, username, or password.</p>
      <img id="profilePicturePreview" src="" alt="Profile picture preview" />
      <button id="profilePictureBtn" aria-label="Change Profile Picture">Change Profile Picture</button>
      <input type="text" id="profileUsername" placeholder="New Username" aria-label="New Username" />
      <input type="password" id="profilePassword" placeholder="New Password" aria-label="New Password" />
      <input type="password" id="profileConfirmPassword" placeholder="Confirm New Password" aria-label="Confirm New Password" />
      <div id="profileButtons">
        <button class="modalBtn" id="profileSaveBtn">Save</button>
        <button class="modalBtn" id="profileCancelBtn">Cancel</button>
      </div>
    </div>
  </section>

  <section id="searchSection" role="region" aria-label="Search Users">
    <div class="converter-container">
      <h1>Search Users</h1>
      <p class="instructions">Enter a username to find other users and send friend requests.</p>
      <input type="text" id="searchInput" placeholder="Search by username" aria-label="Search by username" />
      <div id="searchResults" role="list"></div>
      <h2>Friend Requests</h2>
      <div id="friendRequests" role="list"></div>
    </div>
  </section>

  <section id="friendListSection" role="region" aria-label="Friend List">
    <div class="converter-container">
      <h1>Friend List</h1>
      <p class="instructions">Select a friend to start chatting.</p>
      <div id="friendList" role="list"></div>
    </div>
  </section>

  <section id="chatSection" role="region" aria-label="Chat">
    <div class="converter-container">
      <div class="chat-header">
        <h2 id="chatFriendName"></h2>
        <button id="removeFriendBtn" style="display: none;">Remove Friend</button>
      </div>
      <div id="chatMessages" role="log" aria-live="polite"></div>
      <div class="textarea-container">
        <textarea id="chatInput" rows="2" placeholder="Type a message..." aria-label="Type a message"></textarea>
        <button class="clear-button" onclick="document.getElementById('chatInput').value = ''" aria-label="Clear chat input">×</button>
      </div>
      <div class="chat-controls">
        <button id="sendMessageBtn">Send</button>
        <button id="toggleNumoraBtn">Normal</button>
        <button id="backToFriendsBtn">Back to Friends</button>
      </div>
    </div>
  </section>

  <input type="file" id="fileInput" accept="image/*" multiple aria-label="Upload images" />
  <input type="file" id="profilePictureInput" accept="image/*" aria-label="Upload profile picture" />

  <div id="previewModal" role="dialog" aria-modal="true" aria-labelledby="previewLabel">
    <a id="previewDownload" download target="_blank" aria-label="Download image">Download</a>
    <img id="previewImage" src="" alt="Wallpaper preview" />
  </div>

  <div id="signupLoginModal" role="dialog" aria-modal="true" aria-labelledby="signupLoginTitle" tabIndex="-1">
    <div id="signupLoginModalContent">
      <h2 id="signupLoginTitle">Sign Up or Login</h2>
      <div id="signupLoginTabs" role="tablist">
        <button class="tabBtn active" id="signupTabBtn" onclick="showTab('signup')" role="tab" aria-selected="true">Sign Up</button>
        <button class="tabBtn" id="loginTabBtn" onclick="showTab('login')" role="tab" aria-selected="false">Login</button>
        <button class="tabBtn" id="adminTabBtn" onclick="showTab('admin')" role="tab" aria-selected="false">Admin</button>
      </div>
      <div id="signupTab" class="tabContent active" role="tabpanel">
        <input type="text" id="signupUsername" placeholder="Username" aria-describedby="signupDesc" />
        <input type="password" id="signupPassword" placeholder="Password" />
        <div id="signupLoginButtons">
          <button class="modalBtn" id="signupSubmitBtn">Sign Up</button>
          <button class="modalBtn" id="signupLoginCloseBtn">Close</button>
        </div>
      </div>
      <div id="loginTab" class="tabContent" role="tabpanel">
        <input type="text" id="loginUsername" placeholder="Username" aria-describedby="loginDesc" />
        <input type="password" id="loginPassword" placeholder="Password" />
        <div id="signupLoginButtons">
          <button class="modalBtn" id="loginSubmitBtn">Login</button>
          <button class="modalBtn" id="signupLoginCloseBtn">Close</button>
        </div>
      </div>
      <div id="adminTab" class="tabContent" role="tabpanel">
        <input type="password" id="adminPassword" placeholder="Enter admin code" aria-describedby="adminDesc" />
        <div id="signupLoginButtons">
          <button class="modalBtn" id="adminSubmitBtn">Submit</button>
          <button class="modalBtn" id="signupLoginCloseBtn">Close</button>
        </div>
      </div>
    </div>
  </div>

  <div id="messageModal" role="alertdialog" aria-modal="true" aria-labelledby="messageTitle" tabIndex="-1">
    <div id="messageModalContent">
      <h2 id="messageTitle">Message</h2>
      <p id="messageText" aria-live="assertive"></p>
      <div id="messageButtons">
        <button class="modalBtn" id="messageCloseBtn">Close</button>
      </div>
    </div>
  </div>

  <div id="disconnectModal" role="alertdialog" aria-modal="true" aria-labelledby="disconnectTitle" tabIndex="-1">
    <div id="disconnectModalContent">
      <h2 id="disconnectTitle">Confirm Disconnect</h2>
      <p id="disconnectText">Are you sure you want to disconnect?</p>
      <div id="disconnectButtons">
        <button class="modalBtn" id="disconnectConfirmBtn">Yes</button>
        <button class="modalBtn" id="disconnectCancelBtn">No</button>
      </div>
    </div>
  </div>

  <div id="friendRequestModal" role="alertdialog" aria-modal="true" aria-labelledby="friendRequestTitle" tabIndex="-1">
    <div id="friendRequestModalContent">
      <h2 id="friendRequestTitle">Friend Request</h2>
      <p id="friendRequestText" aria-live="assertive"></p>
      <div id="friendRequestButtons">
        <button class="modalBtn" id="acceptFriendBtn">Accept</button>
        <button class="modalBtn" id="declineFriendBtn">Decline</button>
        <button class="modalBtn" id="friendRequestCloseBtn">Close</button>
      </div>
    </div>
  </div>

  <footer role="contentinfo">
    © 2025 Merqace Library. All rights reserved.
  </footer>

<script>
  // Element references
  const elements = {
    hamburgerBtn: document.getElementById('hamburgerBtn'),
    menu: document.getElementById('menu'),
    signupLoginBtn: document.getElementById('signupLoginBtn'),
    signupLoginMenuBtn: document.getElementById('signupLoginMenuBtn'),
    uploadBtnHeader: document.getElementById('uploadBtnHeader'),
    signupLoginModal: document.getElementById('signupLoginModal'),
    signupLoginCloseBtn: document.querySelectorAll('#signupLoginCloseBtn'),
    signupSubmitBtn: document.getElementById('signupSubmitBtn'),
    loginSubmitBtn: document.getElementById('loginSubmitBtn'),
    adminSubmitBtn: document.getElementById('adminSubmitBtn'),
    signupUsername: document.getElementById('signupUsername'),
    signupPassword: document.getElementById('signupPassword'),
    loginUsername: document.getElementById('loginUsername'),
    loginPassword: document.getElementById('loginPassword'),
    adminPassword: document.getElementById('adminPassword'),
    messageModal: document.getElementById('messageModal'),
    messageText: document.getElementById('messageText'),
    messageCloseBtn: document.getElementById('messageCloseBtn'),
    disconnectBtn: document.getElementById('disconnectBtn'),
    disconnectModal: document.getElementById('disconnectModal'),
    disconnectConfirmBtn: document.getElementById('disconnectConfirmBtn'),
    disconnectCancelBtn: document.getElementById('disconnectCancelBtn'),
    homeBtn: document.getElementById('homeBtn'),
    wallpapersBtn: document.getElementById('wallpapersBtn'),
    converterBtn: document.getElementById('converterBtn'),
    profileBtn: document.getElementById('profileBtn'),
    searchBtn: document.getElementById('searchBtn'),
    friendListBtn: document.getElementById('friendListBtn'),
    profileSection: document.getElementById('profileSection'),
    searchSection: document.getElementById('searchSection'),
    friendListSection: document.getElementById('friendListSection'),
    chatSection: document.getElementById('chatSection'),
    profilePictureInput: document.getElementById('profilePictureInput'),
    profilePicturePreview: document.getElementById('profilePicturePreview'),
    profilePictureBtn: document.getElementById('profilePictureBtn'),
    profileUsername: document.getElementById('profileUsername'),
    profilePassword: document.getElementById('profilePassword'),
    profileConfirmPassword: document.getElementById('profileConfirmPassword'),
    profileSaveBtn: document.getElementById('profileSaveBtn'),
    profileCancelBtn: document.getElementById('profileCancelBtn'),
    searchInput: document.getElementById('searchInput'),
    searchResults: document.getElementById('searchResults'),
    friendRequests: document.getElementById('friendRequests'),
    friendList: document.getElementById('friendList'),
    chatMessages: document.getElementById('chatMessages'),
    chatInput: document.getElementById('chatInput'),
    sendMessageBtn: document.getElementById('sendMessageBtn'),
    toggleNumoraBtn: document.getElementById('toggleNumoraBtn'),
    backToFriendsBtn: document.getElementById('backToFriendsBtn'),
    removeFriendBtn: document.getElementById('removeFriendBtn'),
    friendRequestModal: document.getElementById('friendRequestModal'),
    friendRequestText: document.getElementById('friendRequestText'),
    acceptFriendBtn: document.getElementById('acceptFriendBtn'),
    declineFriendBtn: document.getElementById('declineFriendBtn'),
    friendRequestCloseBtn: document.getElementById('friendRequestCloseBtn'),
    previewModal: document.getElementById('previewModal'),
    previewImage: document.getElementById('previewImage'),
    previewDownload: document.getElementById('previewDownload'),
    gallery: document.getElementById('gallery'),
    fileInput: document.getElementById('fileInput'),
    welcomeMessage: document.getElementById('welcomeMessage'),
    description: document.getElementById('description'),
    welcomeSection: document.getElementById('welcomeSection'),
    converterSection: document.getElementById('converterSection'),
    logo: document.querySelector('.logo'),
    uploadProgress: document.getElementById('uploadProgress'),
    inputText: document.getElementById('inputText'),
    outputText: document.getElementById('outputText'),
    toggleButton: document.getElementById('toggleButton'),
    chatFriendName: document.getElementById('chatFriendName')
  };

  // Define modals and sections collections upfront
  elements.modals = {
    signupLoginModal: elements.signupLoginModal,
    messageModal: elements.messageModal,
    previewModal: elements.previewModal,
    disconnectModal: elements.disconnectModal,
    friendRequestModal: elements.friendRequestModal
  };

  elements.sections = {
    welcomeSection: elements.welcomeSection,
    gallery: elements.gallery,
    converterSection: elements.converterSection,
    profileSection: elements.profileSection,
    searchSection: elements.searchSection,
    friendListSection: elements.friendListSection,
    chatSection: elements.chatSection
  };

  // State variables
  let state = {
    isLoggedIn: false,
    isAdmin: false,
    currentUsername: '',
    uploadedImages: [],
    currentChatFriend: '',
    isNumoraMode: false,
    pollingInterval: null,
    lastMessageCount: null
  };

  // Numora alphabet mapping
  const numoraAlphabet = {
    'a': '∣', 'b': '‒', 'c': 'ˁ', 'd': '●', 'e': '⋋', 'f': '⋌', 'g': '≺', 'h': '⋏', 'i': '≖', 'j': '≻',
    'k': '⊼', 'l': '∦', 'm': '⋂', 'n': '⋃', 'o': '∅', 'p': '∸', 'q': '∀', 'r': '∈', 's': '∼', 't': 'T',
    'u': '∃', 'v': '⋎', 'w': 'w', 'x': 'X', 'y': 'Y', 'z': 'Ω'
  };
  const reverseNumora = Object.fromEntries(Object.entries(numoraAlphabet).map(([k, v]) => [v, k]));

  // Initialize on page load
  window.onload = () => {
    Object.values(elements.modals).forEach(modal => {
      if (modal) modal.classList.remove('show');
    });
    loadState();
    showSection(localStorage.getItem('currentSection') || 'home');
    loadImages();
    updateMenuVisibility();
    typeWelcome();
    createDots();
    if (state.isLoggedIn && !state.isAdmin) {
      updateFriendRequests();
    }
  };

  function loadState() {
    state.isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
    state.isAdmin = localStorage.getItem('isAdmin') === 'true';
    state.currentUsername = localStorage.getItem('currentUsername') || '';
    if (state.isLoggedIn && !state.isAdmin && state.currentUsername) {
      const users = getJSON('users', []);
      if (!users.some(u => u.username === state.currentUsername)) {
        logout();
        showMessage('Session invalid. Please log in again.');
      }
    }
  }

  function loadImages() {
    const storedImages = localStorage.getItem('uploadedImages');
    if (storedImages) {
      try {
        state.uploadedImages = JSON.parse(storedImages);
        elements.gallery.innerHTML = '';
        state.uploadedImages.forEach(image => addImageToGallery(image.url, image.name));
      } catch {
        showMessage('Error loading images.');
        localStorage.removeItem('uploadedImages');
        state.uploadedImages = [];
      }
    }
  }

  function showSection(section) {
    Object.values(elements.sections).forEach(s => {
      if (s) s.style.display = 'none';
    });
    elements.signupLoginBtn.style.display = 'none';
    elements.uploadBtnHeader.style.display = 'none';
    elements.logo.classList.remove('hidden');

    switch (section) {
      case 'home':
        elements.welcomeSection.style.display = 'flex';
        elements.signupLoginBtn.style.display = state.isLoggedIn || state.isAdmin ? 'none' : 'block';
        elements.logo.classList.add('hidden');
        break;
      case 'wallpapers':
        if (!state.isLoggedIn && !state.isAdmin) {
          showMessage('Please sign up or log in to access Wallpapers.');
          return showSection('home');
        }
        elements.gallery.style.display = 'grid';
        elements.uploadBtnHeader.style.display = 'block';
        break;
      case 'converter':
        if (!state.isLoggedIn && !state.isAdmin) {
          showMessage('Please sign up or log in to access Numora Converter.');
          return showSection('home');
        }
        elements.converterSection.style.display = 'flex';
        break;
      case 'profile':
        if (!state.isLoggedIn && !state.isAdmin) {
          showMessage('Please sign up or log in to access Profile.');
          return showSection('home');
        }
        elements.profileSection.style.display = 'flex';
        loadProfileData();
        break;
      case 'search':
        if (!state.isLoggedIn || state.isAdmin) {
          showMessage('Please log in as a regular user to search users.');
          return showSection('home');
        }
        elements.searchSection.style.display = 'flex';
        updateFriendRequests();
        break;
      case 'friendList':
        if (!state.isLoggedIn || state.isAdmin) {
          showMessage('Please log in as a regular user to view friends.');
          return showSection('home');
        }
        elements.friendListSection.style.display = 'flex';
        updateFriendList();
        break;
      case 'chat':
        if (!state.isLoggedIn || state.isAdmin) {
          showMessage('Please log in as a regular user to chat.');
          return showSection('home');
        }
        elements.chatSection.style.display = 'flex';
        break;
    }
    localStorage.setItem('currentSection', section);
  }

  function updateMenuVisibility() {
    const visibility = {
      signupLoginBtn: !state.isLoggedIn && !state.isAdmin,
      signupLoginMenuBtn: !state.isLoggedIn && !state.isAdmin,
      wallpapersBtn: state.isLoggedIn || state.isAdmin,
      converterBtn: state.isLoggedIn || state.isAdmin,
      profileBtn: state.isLoggedIn || state.isAdmin,
      disconnectBtn: state.isLoggedIn || state.isAdmin,
      searchBtn: state.isLoggedIn && !state.isAdmin,
      friendListBtn: state.isLoggedIn && !state.isAdmin
    };
    Object.entries(visibility).forEach(([id, show]) => {
      if (elements[id]) elements[id].style.display = show ? 'block' : 'none';
    });
  }

  function loadProfileData() {
    elements.profileUsername.value = state.currentUsername;
    elements.profilePassword.value = '';
    elements.profileConfirmPassword.value = '';
    const users = getJSON('users', []);
    const user = users.find(u => u.username === state.currentUsername);
    elements.profilePicturePreview.src = user?.profilePicture || '';
    const disabled = state.isAdmin;
    elements.profileUsername.disabled = disabled;
    elements.profilePassword.disabled = disabled;
    elements.profileConfirmPassword.disabled = disabled;
    elements.profilePictureBtn.disabled = disabled;
    elements.profileSaveBtn.disabled = disabled;
    if (disabled) showMessage('Admin accounts cannot modify profile details.');
  }

  function typeWelcome() {
    const text = "Welcome to Merqace Library!";
    let i = 0;
    function type() {
      if (i < text.length) {
        elements.welcomeMessage.textContent = text.substring(0, ++i);
        elements.welcomeMessage.innerHTML += '<span class="cursor"></span>';
        setTimeout(type, 100);
      } else {
        elements.welcomeMessage.innerHTML = text;
        typeDescription();
      }
    }
    type();
  }

  function typeDescription() {
    const text = "";
    let i = 0;
    function type() {
      if (i < text.length) {
        elements.description.textContent = text.substring(0, ++i);
        elements.description.innerHTML += '<span class="cursor"></span>';
        setTimeout(type, 80);
      } else {
        elements.description.innerHTML = text;
      }
    }
    type();
  }

  function createDots() {
    for (let i = 0; i < 20; i++) {
      const dot = document.createElement('div');
      dot.classList.add('dot');
      Object.assign(dot.style, {
        width: `${Math.random() * 8 + 2}px`,
        height: `${Math.random() * 8 + 2}px`,
        left: `${Math.random() * 100}%`,
        top: `${Math.random() * 100}%`,
        '--x-move': `${(Math.random() - 0.5) * 100}px`,
        '--y-move': `${(Math.random() - 0.5) * 100}px`,
        animationDelay: `${Math.random() * 5}s`
      });
      elements.welcomeSection.appendChild(dot);
    }
  }

  elements.hamburgerBtn.addEventListener('click', () => {
    const expanded = elements.hamburgerBtn.getAttribute('aria-expanded') === 'true';
    elements.hamburgerBtn.setAttribute('aria-expanded', !expanded);
    elements.hamburgerBtn.classList.toggle('active');
    elements.menu.classList.toggle('show');
  });

  ['homeBtn', 'wallpapersBtn', 'converterBtn', 'profileBtn', 'searchBtn', 'friendListBtn'].forEach(id => {
    elements[id].addEventListener('click', e => {
      e.preventDefault();
      elements.hamburgerBtn.setAttribute('aria-expanded', 'false');
      elements.hamburgerBtn.classList.remove('active');
      elements.menu.classList.remove('show');
      const sections = {
        'Home': 'home',
        'Wallpapers': 'wallpapers',
        'Numora Converter': 'converter',
        'Profile': 'profile',
        'Search Users': 'search',
        'Friend List': 'friendList'
      };
      showSection(sections[elements[id].textContent]);
    });
  });

  elements.fileInput.addEventListener('change', handleImageUpload);

  function handleImageUpload(e) {
    const files = Array.from(e.target.files);
    if (!files.length) return;
    let processed = 0, valid = 0;
    const total = files.length;
    elements.uploadProgress.style.display = 'block';
    elements.uploadProgress.textContent = `Uploading 0/${total} images...`;
    const newImages = [];
    files.forEach(file => {
      if (file.size > 5 * 1024 * 1024) {
        showMessage(`File "${file.name}" exceeds 5MB limit.`);
        processed++;
        updateUploadProgress(processed, total, valid);
        return;
      }
      const reader = new FileReader();
      reader.onload = event => {
        const imageUrl = event.target.result;
        addImageToGallery(imageUrl, file.name);
        newImages.push({ url: imageUrl, name: file.name });
        valid++;
        processed++;
        updateUploadProgress(processed, total, valid);
        if (processed === total) {
          state.uploadedImages.push(...newImages);
          saveImages();
        }
      };
      reader.onerror = () => {
        processed++;
        updateUploadProgress(processed, total, valid);
      };
      reader.readAsDataURL(file);
    });
    elements.fileInput.value = '';
  }

  function updateUploadProgress(processed, total, valid) {
    elements.uploadProgress.textContent = `Uploading ${processed}/${total} images...`;
    if (processed === total) {
      elements.uploadProgress.style.display = 'none';
      showMessage(valid > 0 ? `${valid} image${valid > 1 ? 's' : ''} uploaded successfully!` : 'No valid images uploaded.');
    }
  }

  function addImageToGallery(imageUrl, fileName) {
    const card = document.createElement('div');
    card.classList.add('card');
    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = 'Uploaded image';
    if (state.isAdmin) {
      const deleteBtn = document.createElement('button');
      deleteBtn.classList.add('delete-btn');
      deleteBtn.textContent = '×';
      deleteBtn.setAttribute('aria-label', 'Delete image');
      deleteBtn.addEventListener('click', e => {
        e.stopPropagation();
        const index = state.uploadedImages.findIndex(img => img.url === imageUrl);
        if (index !== -1) {
          state.uploadedImages.splice(index, 1);
          saveImages();
          card.remove();
          showMessage('Image deleted successfully.');
        }
      });
      card.appendChild(deleteBtn);
    }
    card.appendChild(img);
    elements.gallery.appendChild(card);
    card.addEventListener('click', () => {
      elements.previewImage.src = imageUrl;
      elements.previewDownload.href = imageUrl;
      elements.previewDownload.download = fileName;
      elements.previewModal.classList.add('show');
      elements.signupLoginBtn.style.display = 'none';
      elements.uploadBtnHeader.style.display = 'none';
      elements.logo.classList.remove('hidden');
    });
  }

  function saveImages() {
    try {
      localStorage.setItem('uploadedImages', JSON.stringify(state.uploadedImages));
    } catch {
      showMessage('Storage limit reached. Some images not saved.');
      while (state.uploadedImages.length > 0) {
        state.uploadedImages.pop();
        try {
          localStorage.setItem('uploadedImages', JSON.stringify(state.uploadedImages));
          break;
        } catch {}
      }
      elements.gallery.innerHTML = '';
      state.uploadedImages.forEach(image => addImageToGallery(image.url, image.name));
    }
  }

  elements.uploadBtnHeader.addEventListener('click', () => {
    if (state.isAdmin) elements.fileInput.click();
    else showMessage('Only admins can upload images.');
  });

  [elements.signupLoginBtn, elements.signupLoginMenuBtn].forEach(btn => btn.addEventListener('click', openSignupLoginModal));

  function openSignupLoginModal() {
    elements.signupLoginModal.classList.add('show');
    showTab('signup');
    ['signupUsername', 'signupPassword', 'loginUsername', 'loginPassword', 'adminPassword'].forEach(id => elements[id].value = '');
    elements.signupUsername.focus();
    elements.signupLoginBtn.style.display = 'none';
    elements.uploadBtnHeader.style.display = 'none';
    elements.logo.classList.remove('hidden');
  }

  elements.signupLoginCloseBtn.forEach(btn => btn.addEventListener('click', closeSignupLoginModal));

  function closeSignupLoginModal() {
    elements.signupLoginModal.classList.remove('show');
    if (elements.welcomeSection.style.display === 'flex') {
      elements.signupLoginBtn.style.display = state.isLoggedIn || state.isAdmin ? 'none' : 'block';
      elements.logo.classList.add('hidden');
    }
    if (elements.gallery.style.display === 'grid') elements.uploadBtnHeader.style.display = 'block';
  }

  function showTab(tabName) {
    document.querySelectorAll('.tabContent').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tabBtn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(`${tabName}Tab`).classList.add('active');
    document.getElementById(`${tabName}TabBtn`).classList.add('active');
    document.getElementById(`${tabName}TabBtn`).setAttribute('aria-selected', 'true');
    document.querySelectorAll('.tabBtn').forEach(btn => {
      if (btn.id !== `${tabName}TabBtn`) btn.setAttribute('aria-selected', 'false');
    });
    elements[`${tabName}Username`]?.focus() || elements.adminPassword.focus();
  }

  elements.signupSubmitBtn.addEventListener('click', () => {
    const username = elements.signupUsername.value.trim();
    const password = elements.signupPassword.value.trim();
    if (!username || !password) return showMessage('Please enter both username and password.');
    const users = getJSON('users', []);
    if (users.some(user => user.username === username) || username === 'admin') {
      return showMessage('Username already exists. Please choose another.');
    }
    users.push({ username, password, profilePicture: '', friends: [], friendRequests: [] });
    setJSON('users', users);
    showMessage('Sign up successful! Please log in.');
    showTab('login');
    elements.signupUsername.value = '';
    elements.signupPassword.value = '';
  });

  elements.loginSubmitBtn.addEventListener('click', () => {
    const username = elements.loginUsername.value.trim();
    const password = elements.loginPassword.value.trim();
    if (!username || !password) return showMessage('Please enter both username and password.');
    const users = getJSON('users', []);
    const user = users.find(user => user.username === username && user.password === password);
    if (!user) return showMessage('Invalid username or password.');
    user.friends = user.friends || [];
    user.friendRequests = user.friendRequests || [];
    setJSON('users', users);
    login(username, false);
    elements.signupLoginModal.classList.remove('show');
    showMessage('Login successful!');
    updateFriendRequests();
  });

  elements.adminSubmitBtn.addEventListener('click', () => {
    if (elements.adminPassword.value === 'b3d5ec73f3b82d3db73f') {
      login('admin', true);
      elements.signupLoginModal.classList.remove('show');
      showMessage('Welcome Admin!');
    } else {
      showMessage('Access denied: Invalid admin code.');
    }
  });

  function login(username, isAdmin) {
    state.isLoggedIn = true;
    state.isAdmin = isAdmin;
    state.currentUsername = username;
    localStorage.setItem('isLoggedIn', 'true');
    localStorage.setItem('isAdmin', isAdmin);
    localStorage.setItem('currentUsername', username);
    updateMenuVisibility();
  }

  elements.disconnectBtn.addEventListener('click', () => {
    elements.disconnectModal.classList.add('show');
    elements.hamburgerBtn.setAttribute('aria-expanded', 'false');
    elements.hamburgerBtn.classList.remove('active');
    elements.menu.classList.remove('show');
  });

  elements.disconnectConfirmBtn.addEventListener('click', () => {
    logout();
    elements.disconnectModal.classList.remove('show');
    updateMenuVisibility();
    showSection('home');
    showMessage('Disconnected successfully.');
    stopChatPolling();
  });

  function logout() {
    state.isLoggedIn = false;
    state.isAdmin = false;
    state.currentUsername = '';
    localStorage.setItem('isLoggedIn', 'false');
    localStorage.setItem('isAdmin', 'false');
    localStorage.setItem('currentUsername', '');
  }

  elements.disconnectCancelBtn.addEventListener('click', () => {
    elements.disconnectModal.classList.remove('show');
  });

  elements.messageCloseBtn.addEventListener('click', () => {
    elements.messageModal.classList.remove('show');
  });

  function showMessage(text) {
    elements.messageText.textContent = text;
    elements.messageModal.classList.add('show');
    setTimeout(() => elements.messageModal.classList.remove('show'), 3000);
  }

  Object.values(elements.modals).forEach(modal => {
    modal.addEventListener('click', e => {
      if (e.target === modal) {
        modal.classList.remove('show');
        if (elements.welcomeSection.style.display === 'flex') {
          elements.signupLoginBtn.style.display = state.isLoggedIn || state.isAdmin ? 'none' : 'block';
          elements.logo.classList.add('hidden');
        }
        if (elements.gallery.style.display === 'grid') elements.uploadBtnHeader.style.display = 'block';
      }
    });
  });

  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      Object.values(elements.modals).forEach(modal => {
        if (modal) modal.classList.remove('show');
      });
      if (elements.menu.classList.contains('show')) {
        elements.menu.classList.remove('show');
        elements.hamburgerBtn.classList.remove('active');
        elements.hamburgerBtn.setAttribute('aria-expanded', 'false');
      }
      if (elements.welcomeSection.style.display === 'flex') {
        elements.signupLoginBtn.style.display = state.isLoggedIn || state.isAdmin ? 'none' : 'block';
        elements.logo.classList.add('hidden');
      }
      if (elements.gallery.style.display === 'grid') elements.uploadBtnHeader.style.display = 'block';
    }
  });

  elements.profilePictureBtn.addEventListener('click', () => {
    elements.profilePictureInput.click();
  });

  elements.profilePictureInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    if (file.size > 5 * 1024 * 1024) {
      showMessage('Profile picture exceeds 5MB limit.');
      elements.profilePictureInput.value = '';
      return;
    }
    const reader = new FileReader();
    reader.onload = event => {
      elements.profilePicturePreview.src = event.target.result;
      elements.profilePictureInput.value = '';
    };
    reader.onerror = () => {
      showMessage('Failed to upload profile picture.');
      elements.profilePictureInput.value = '';
    };
    reader.readAsDataURL(file);
  });

  elements.profileSaveBtn.addEventListener('click', saveProfile);

  function saveProfile() {
    if (state.isAdmin) return showMessage('Admin accounts cannot modify profile details.');
    const newUsername = elements.profileUsername.value.trim();
    const newPassword = elements.profilePassword.value.trim();
    const confirmPassword = elements.profileConfirmPassword.value.trim();
    const profilePicture = elements.profilePicturePreview.src;
    const users = getJSON('users', []);
    const userIndex = users.findIndex(user => user.username === state.currentUsername);
    if (userIndex === -1) return showMessage('User not found.');
    if (newUsername && newUsername !== state.currentUsername) {
      if (users.some(user => user.username === newUsername) || newUsername === 'admin') {
        return showMessage('Username already exists. Please choose another.');
      }
      users[userIndex].username = newUsername;
      updateFriendData(state.currentUsername, newUsername);
      state.currentUsername = newUsername;
      localStorage.setItem('currentUsername', newUsername);
    }
    if (newPassword) {
      if (newPassword !== confirmPassword) return showMessage('Passwords do not match.');
      users[userIndex].password = newPassword;
    }
    if (profilePicture) users[userIndex].profilePicture = profilePicture;
    setJSON('users', users);
    showMessage('Profile updated successfully!');
    loadProfileData();
  }

  function updateFriendData(oldUsername, newUsername) {
    const users = getJSON('users', []);
    users.forEach(user => {
      if (user.friends?.includes(oldUsername)) {
        user.friends = user.friends.map(f => f === oldUsername ? newUsername : f);
      }
      if (user.friendRequests?.some(req => req.from === oldUsername)) {
        user.friendRequests = user.friendRequests.map(req => req.from === oldUsername ? { ...req, from: newUsername } : req);
      }
    });
    const messages = getJSON('messages', {});
    for (let chatId in messages) {
      if (chatId.includes(oldUsername)) {
        const newChatId = chatId.replace(oldUsername, newUsername);
        messages[newChatId] = messages[chatId].map(msg => ({
          ...msg,
          sender: msg.sender === oldUsername ? newUsername : msg.sender
        }));
        delete messages[chatId];
      }
    }
    setJSON('users', users);
    setJSON('messages', messages);
  }

  elements.profileCancelBtn.addEventListener('click', () => showSection('home'));

  elements.searchInput.addEventListener('input', handleSearch);

  function handleSearch() {
    const query = elements.searchInput.value.trim().toLowerCase();
    elements.searchResults.innerHTML = '';
    if (!query) return;
    const users = getJSON('users', []);
    const currentUser = users.find(u => u.username === state.currentUsername);
    if (!currentUser) {
      showMessage('User data not found. Please log in again.');
      return logout();
    }
    const filteredUsers = users.filter(user => 
      user.username.toLowerCase().includes(query) && 
      user.username !== state.currentUsername && 
      user.username !== 'admin' &&
      !currentUser.friends.includes(user.username) &&
      !currentUser.friendRequests.some(req => req.from === user.username)
    );
    filteredUsers.forEach(user => {
      const resultDiv = document.createElement('div');
      resultDiv.classList.add('search-result');
      resultDiv.innerHTML = `<span>${user.username}</span>`;
      const addBtn = document.createElement('button');
      addBtn.textContent = 'Add Friend';
      addBtn.setAttribute('aria-label', `Send friend request to ${user.username}`);
      addBtn.addEventListener('click', () => sendFriendRequest(user.username, resultDiv));
      resultDiv.appendChild(addBtn);
      elements.searchResults.appendChild(resultDiv);
    });
  }

  function sendFriendRequest(username, resultDiv) {
    const users = getJSON('users', []);
    const targetUser = users.find(u => u.username === username);
    if (!targetUser) return showMessage('User not found.');
    if (targetUser.friendRequests.some(req => req.from === state.currentUsername)) {
      return showMessage('Friend request already sent.');
    }
    targetUser.friendRequests = targetUser.friendRequests || [];
    targetUser.friendRequests.push({ from: state.currentUsername, date: new Date().toISOString() });
    setJSON('users', users);
    showMessage(`Friend request sent to ${username}!`);
    resultDiv.remove();
  }

  function updateFriendRequests() {
    elements.friendRequests.innerHTML = '';
    const users = getJSON('users', []);
    const currentUser = users.find(u => u.username === state.currentUsername);
    if (!currentUser) {
      showMessage('User data not found. Please log in again.');
      return logout();
    }
    currentUser.friendRequests = currentUser.friendRequests || [];
    currentUser.friendRequests.forEach(req => {
      const reqDiv = document.createElement('div');
      reqDiv.classList.add('search-result');
      reqDiv.innerHTML = `<span>From: ${req.from}</span>`;
      const viewBtn = document.createElement('button');
      viewBtn.textContent = 'View';
      viewBtn.setAttribute('aria-label', `View friend request from ${req.from}`);
      viewBtn.addEventListener('click', () => showFriendRequest(req));
      reqDiv.appendChild(viewBtn);
      elements.friendRequests.appendChild(reqDiv);
    });
  }

  function showFriendRequest(req) {
    elements.friendRequestText.textContent = `${req.from} wants to be your friend.`;
    elements.friendRequestModal.classList.add('show');
    elements.acceptFriendBtn.onclick = () => acceptFriendRequest(req);
    elements.declineFriendBtn.onclick = () => declineFriendRequest(req);
  }

  function acceptFriendRequest(req) {
    const users = getJSON('users', []);
    const sender = users.find(u => u.username === req.from);
    const receiver = users.find(u => u.username === state.currentUsername);
    if (!sender || !receiver) {
      showMessage('User data not found.');
      elements.friendRequestModal.classList.remove('show');
      return;
    }
    receiver.friendRequests = receiver.friendRequests.filter(r => r.from !== req.from);
    receiver.friends = receiver.friends || [];
    sender.friends = sender.friends || [];
    receiver.friends.push(req.from);
    sender.friends.push(state.currentUsername);
    setJSON('users', users);
    elements.friendRequestModal.classList.remove('show');
    showMessage(`You are now friends with ${req.from}!`);
    updateFriendRequests();
    updateFriendList();
  }

  function declineFriendRequest(req) {
    const users = getJSON('users', []);
    const receiver = users.find(u => u.username === state.currentUsername);
    if (!receiver) {
      showMessage('User data not found.');
      elements.friendRequestModal.classList.remove('show');
      return;
    }
    receiver.friendRequests = receiver.friendRequests.filter(r => r.from !== req.from);
    setJSON('users', users);
    elements.friendRequestModal.classList.remove('show');
    showMessage(`Declined friend request from ${req.from}.`);
    updateFriendRequests();
  }

  elements.friendRequestCloseBtn.addEventListener('click', () => {
    elements.friendRequestModal.classList.remove('show');
  });

  function updateFriendList() {
    elements.friendList.innerHTML = '';
    const users = getJSON('users', []);
    const currentUser = users.find(u => u.username === state.currentUsername);
    if (!currentUser) {
      showMessage('User data not found. Please log in again.');
      return logout();
    }
    currentUser.friends = currentUser.friends || [];
    if (currentUser.friends.length === 0) {
      elements.friendList.innerHTML = '<p>No friends yet. Search for users to add friends!</p>';
      return;
    }
    currentUser.friends.forEach(friend => {
      const friendDiv = document.createElement('div');
      friendDiv.classList.add('friend-item');
      friendDiv.innerHTML = `<span>${friend}</span>`;
      const chatBtn = document.createElement('button');
      chatBtn.textContent = 'Chat';
      chatBtn.setAttribute('aria-label', `Start chat with ${friend}`);
      chatBtn.addEventListener('click', () => {
        state.currentChatFriend = friend;
        elements.chatFriendName.textContent = `Chat with ${friend}`;
        elements.removeFriendBtn.style.display = 'inline-block';
        loadChatMessages();
        showSection('chat');
        startChatPolling();
        elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
      });
      friendDiv.appendChild(chatBtn);
      elements.friendList.appendChild(friendDiv);
    });
  }

  function startChatPolling() {
    if (state.pollingInterval) return;
    state.pollingInterval = setInterval(() => {
      if (!state.currentChatFriend) return;
      const messages = getJSON('messages', {});
      const chatId = [state.currentUsername, state.currentChatFriend].sort().join('_');
      const currentMessages = messages[chatId] || [];
      if (state.lastMessageCount !== null && currentMessages.length !== state.lastMessageCount) {
        loadChatMessages();
        elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
      }
      state.lastMessageCount = currentMessages.length;
    }, 2000);
  }

  function stopChatPolling() {
    if (state.pollingInterval) {
      clearInterval(state.pollingInterval);
      state.pollingInterval = null;
      state.lastMessageCount = null;
    }
  }

  function loadChatMessages() {
    if (!state.currentChatFriend) {
      elements.chatMessages.innerHTML = '<p>No friend selected.</p>';
      return;
    }
    elements.chatMessages.innerHTML = '';
    const messages = getJSON('messages', {});
    const chatId = [state.currentUsername, state.currentChatFriend].sort().join('_');
    const chat = messages[chatId] || [];
    chat.forEach(msg => {
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('chat-message');
      const sender = document.createElement('p');
      sender.textContent = `${msg.sender}:`;
      msgDiv.appendChild(sender);
      const content = document.createElement('p');
      content.textContent = msg.content;
      msgDiv.appendChild(content);
      const convertBtn = document.createElement('button');
      convertBtn.textContent = 'Convert';
      convertBtn.setAttribute('aria-label', 'Convert message to Numora/Alphabet');
      convertBtn.addEventListener('click', () => {
        const isNumora = Object.values(numoraAlphabet).some(symbol => msg.content.includes(symbol));
        const converted = isNumora ? numoraToAlphabet(msg.content) : alphabetToNumora(msg.content);
        showMessage(`Converted: ${converted}`);
      });
      msgDiv.appendChild(convertBtn);
      const time = document.createElement('p');
      time.style.fontSize = '0.8em';
      time.style.color = '#ccc';
      time.textContent = new Date(msg.timestamp).toLocaleTimeString();
      msgDiv.appendChild(time);
      elements.chatMessages.appendChild(msgDiv);
    });
    state.lastMessageCount = chat.length;
  }

  elements.sendMessageBtn.addEventListener('click', sendMessage);

  function sendMessage() {
    if (!state.currentChatFriend) return showMessage('Please select a friend to chat with.');
    let messageContent = elements.chatInput.value.trim();
    if (!messageContent) return;
    if (state.isNumoraMode) {
      messageContent = alphabetToNumora(messageContent);
      if (!messageContent) return showMessage('No valid letters to convert to Numora.');
    }
    const messages = getJSON('messages', {});
    const chatId = [state.currentUsername, state.currentChatFriend].sort().join('_');
    messages[chatId] = messages[chatId] || [];
    messages[chatId].push({
      sender: state.currentUsername,
      content: messageContent,
      type: 'text',
      timestamp: new Date().toISOString()
    });
    setJSON('messages', messages);
    elements.chatInput.value = '';
    loadChatMessages();
    elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
  }

  elements.toggleNumoraBtn.addEventListener('click', () => {
    state.isNumoraMode = !state.isNumoraMode;
    elements.toggleNumoraBtn.textContent = state.isNumoraMode ? 'Numora' : 'Normal';
  });

  elements.backToFriendsBtn.addEventListener('click', () => {
    stopChatPolling();
    state.currentChatFriend = '';
    elements.chatFriendName.textContent = '';
    elements.removeFriendBtn.style.display = 'none';
    showSection('friendList');
  });

  elements.removeFriendBtn.addEventListener('click', () => {
    if (!state.currentChatFriend) return;
    const users = getJSON('users', []);
    const currentUser = users.find(u => u.username === state.currentUsername);
    const friend = users.find(u => u.username === state.currentChatFriend);
    if (!currentUser || !friend) {
      showMessage('User data not found.');
      return;
    }
    currentUser.friends = currentUser.friends.filter(f => f !== state.currentChatFriend);
    friend.friends = friend.friends.filter(f => f !== state.currentUsername);
    const messages = getJSON('messages', {});
    const chatId = [state.currentUsername, state.currentChatFriend].sort().join('_');
    delete messages[chatId];
    setJSON('users', users);
    setJSON('messages', messages);
    showMessage(`Removed ${state.currentChatFriend} as a friend.`);
    stopChatPolling();
    state.currentChatFriend = '';
    elements.chatFriendName.textContent = '';
    elements.removeFriendBtn.style.display = 'none';
    showSection('friendList');
  });

  function alphabetToNumora(text) {
    return text.toLowerCase()
      .split('')
      .filter(c => /[a-z]/.test(c))
      .map(c => numoraAlphabet[c] || '')
      .join('') || '';
  }

  function numoraToAlphabet(text) {
    return text.split('')
      .map(c => reverseNumora[c] || '')
      .filter(c => c)
      .join('') || 'Invalid Numora input';
  }

  // Numora Converter Functions
  function clearText() {
    elements.inputText.value = '';
    elements.outputText.textContent = '';
  }

  function toggleConversion() {
    const isNumoraToAlphabet = elements.toggleButton.textContent === 'Numora → Alphabet';
    elements.toggleButton.textContent = isNumoraToAlphabet ? 'Alphabet → Numora' : 'Numora → Alphabet';
    convertText(elements.inputText.value.trim());
  }

  function convertText(input) {
    const isNumoraToAlphabet = elements.toggleButton.textContent === 'Numora → Alphabet';
    if (!input) {
      elements.outputText.textContent = '';
      return;
    }
    try {
      if (isNumoraToAlphabet) {
        elements.outputText.textContent = numoraToAlphabet(input) || 'Invalid Numora input';
      } else {
        const result = alphabetToNumora(input);
        elements.outputText.textContent = result || 'No valid letters found';
      }
    } catch {
      elements.outputText.textContent = 'Error during conversion';
    }
  }

  function copyOutput() {
    const text = elements.outputText.textContent;
    if (!text) return showMessage('Nothing to copy.');
    navigator.clipboard.writeText(text)
      .then(() => showMessage('Copied to clipboard!'))
      .catch(() => showMessage('Failed to copy.'));
  }

  elements.inputText.addEventListener('input', e => convertText(e.target.value.trim()));

  // Utility functions
  function getJSON(key, defaultValue) {
    try {
      return JSON.parse(localStorage.getItem(key)) || defaultValue;
    } catch {
      return defaultValue;
    }
  }

  function setJSON(key, value) {
    try {
      localStorage.setItem(key, JSON.stringify(value));
    } catch {
      showMessage(`Error saving ${key}. Storage may be full.`);
    }
  }
</script>
</body>
</html>
